let dataset = {
    "1": {
        "questions": [
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/5c65783c-a671-436c-b2fd-7d79abf2066b/playlist.m3u8",
                "question": "What is Entrepreneurship?",
                "options": [
                    "Pain",
                    "Punishment",
                    "Pleasure",
                    "Torture"
                ],
                "correct": "Pain"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/27de84eb-936b-429b-adb7-94030af5885d/playlist.m3u8",
                "question": "What is soch ka chakravyuh?",
                "options": [
                    "Thoughts without implementation",
                    "Thoughts with implementation",
                    "Actions without a planning",
                    "Overplanning"
                ],
                "correct": "Thoughts without implementation"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/9c32edaf-0289-4a3a-8987-4e5eed8b7186/playlist.m3u8",
                "question": "What is Halat ka chakravyuh?",
                "options": [
                    "People stopping growth",
                    "People empowering growth",
                    "Blaming conditions for grown",
                    "Inability to take risk"
                ],
                "correct": "People stopping growth"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/b5ace4f0-ea2e-4476-82ad-d82063114066/playlist.m3u8",
                "question": "What is Urja ka chakravyuh?",
                "options": [
                    "Spending efforts in operations",
                    "Spending time innovating",
                    "Efficient energy utilization",
                    "Spending time in finances"
                ],
                "correct": "Spending efforts in operations"
            }
        ]
    },
    "2": {
        "questions": [
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/069f4711-1579-43fd-9e00-d43bf5e35922/playlist.m3u8",
                "question": "What is productivity?",
                "options": [
                    "Max result in Min Time",
                    "Max result in Max Time",
                    "Min result in Max Time",
                    "Min result in Min Time"
                ],
                "correct": "Max result in Min Time"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/90adc8f0-7366-4886-8187-89515c8425a4/playlist.m3u8",
                "question": "What is Leverage?",
                "options": [
                    "Max result in Min efforts",
                    "Max result in Max efforts",
                    "Min result in Min efforts",
                    "Min result in Max efforts"
                ],
                "correct": "Max result in Min efforts"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/fa423763-e11e-45ac-abca-6b4425539796/playlist.m3u8",
                "question": "What is the most important thing for the growth of an organization?",
                "options": [
                    "Smart delegation",
                    "Finances",
                    "Fancy degrees",
                    "Operations"
                ],
                "correct": "Smart delegation"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/4a4f4e00-a1d8-4d6c-8631-cdf521a8f216/playlist.m3u8",
                "question": "What are the 2 decisions taken by every entrepreneur?",
                "options": [
                    "Value creation & Skills development",
                    "Economic returns & Self reliant",
                    "Financials gains & Tedious work",
                    "Tedious Work & Daily operations"
                ],
                "correct": "Value creation & Skills development"
            }
        ]
    },
    "3": {
        "questions": [
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/b629b706-746a-40a4-a50a-ecabc5fbdc60/playlist.m3u8?",
                "question": "Which of the following is not a component of value creation?",
                "options": [
                    "Finance",
                    "Leadership",
                    "Relationship",
                    "Creativity"
                ],
                "correct": "Finance"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/c9a47455-04a9-4df9-b1ec-8367124db221/playlist.m3u8",
                "question": "What is Leadership?",
                "options": [
                    "Providing direction",
                    "Giving order",
                    "Being a know it all",
                    "Micromanaging everything"
                ],
                "correct": "Providing direction"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/94424938-f344-4768-b428-b8b90ee5e3d9/playlist.m3u8",
                "question": "What is relationship?",
                "options": [
                    "Providing confidence",
                    "Giving orders",
                    "Expecting results",
                    "Burning out colleagues"
                ],
                "correct": "Providing confidence"
            },
            {
                "video": "https://vz-da0317b0-84a.b-cdn.net/d7239090-e4a0-4c65-989d-350d578fffc7/playlist.m3u8",
                "question": "What is creativity?",
                "options": [
                    "Providing capability",
                    "Do everything yourself",
                    "Non-strategic thinking",
                    "Avoid Risk Taking"
                ],
                "correct": "Providing capability"
            }
        ]
    },
    "right": {
        "video": "https://vz-09c53bdb-c9e.b-cdn.net/6c186e8e-03d9-4e30-9822-50a63c7d50e1/playlist.m3u8"
    },
    "won": {
        "video": "https://vz-09c53bdb-c9e.b-cdn.net/95f2ef98-4805-4a69-81d0-df1b4d7e1336/playlist.m3u8",
        "message": "Winning message"
    },
    "time": {
        "video": "https://vz-09c53bdb-c9e.b-cdn.net/fc3fc38f-3aa4-4c2a-87b3-e3e053c62c6b/playlist.m3u8",
        "message": "Click On The Button Below To Try Again",
        "option": "Play Again"
    },
    "wrong": {
        "video": "https://vz-09c53bdb-c9e.b-cdn.net/0c3e4889-971a-41e4-a658-ab88d7e0eec7/playlist.m3u8",
        "message": "Sorry you did not clear stage 1",
        "option": "Try again"
    },
    "form": {
        "lead": [
            {
                "type": "string",
                "identifier": "name",
                "label": "Full name"
            },
            {
                "type": "email",
                "identifier": "emailid",
                "label": "Email Address"
            },
            {
                "type": "number",
                "identifier": "phone",
                "label": "Phone number"
            }
        ]
    }
};
let interval;
let mute = 'muted';
let active = false;
let dataObj = { date: new Date().toISOString() };

const bottomText = `
    <div class="bottom-text">
        <span>Powered By Sprout</span>
    </div>`;

// (function() {
//     fetch(`https://ourauthbackend.com/widget?url=${window.location.href}`)
//     .then(data => data.json())
//     .then((json) => {
//         if (json?.token) {
//             renderWidget();
//         }
//     })
// })();

renderWidget()

function renderWidget() {
    return document.write(
        `<div id="interactive-interface"> 
            <div id="trigger" onclick="initiateInterface()">
                <img src="./assets/logo-dark.svg" style="height: 40px; width: 60px;">
            </div>
        </div>`
    )
};

function initiateInterface() {
    active = true;
    document.getElementById("interactive-interface").innerHTML = `<div class="container">
        <div class="frame" id="frameDiv">
            <div class="video-container">
                <div class="videos" id="videosDiv">
                    <div class="video">
                        <video id="background" class="video-js vjs-fill" autoplay="true" preload="auto" loop="true" playsinline muted>
                            <source src="https://vz-da0317b0-84a.b-cdn.net/d1571318-c13d-4604-8e74-8328b9a3113c/playlist.m3u8" type="application/x-mpegURL">
                        </video>
                    </div>
                </div>
                <div class="header_section">
                     <img id="logo" src="./assets/logo-dark.svg">
                    <div class="icons-wrapper">
                        <img src="./assets/close.svg" onclick="closeInterface()">
                        <img id="speaker" src="./assets/mute.svg" onclick="toggleSound()">
                    </div>
                </div>
                <div class="options" id="optionsDiv">
                    <div class="currentOptions" id="currentOptionsDiv">
                        <div class="question">
                            <h3>Welcome to the Quiz</h3>
                            <h4>Play to win. Click below to get started</h4>
                        </div>
                        <div class="answers cta">
                            <button type="button" value="1" onclick=${localStorage.getItem("lead") ? "nextVideo('1')" : "showForm()"}>Get Started</button>
                            ${bottomText}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form" id="formDiv">
            <div class="form-content">
                <div class="textOnForm">
                    <div class="form-text">
                        <img src="./assets/close.svg" onclick="closeForm()">
                    </div>
                    <div class="form-client-logo">
                        <h4>Get In Touch</h4>
                    </div>
                </div>
                <div class="fields" id="fieldsDiv">
              
                </div>
                <button type="button" class="submit" value="submit" onclick="sendInfo()">Submit</button>
            </div>
        </div>
        <div class="formStatus" id="formStatusDiv">
            <p id="status"></p>
        </div>
    </div>`
    videojs("background").ready(function() { this.player_.controls(false) });
};

function closeInterface() {
    stopTimer();
    videojs(getVideoId()).dispose();
    active = false;
    document.getElementById("interactive-interface").innerHTML = `<div id="trigger" onclick="initiateInterface()">
        <img src="./assets/logo-dark.svg" style="height: 40px; width: 60px;">
    </div>`
}

function getVideoId() {
    let video = document.getElementsByClassName('video')
    video = Array.from(video);
    video = Array.from(video[0].children);
    if (video.length > 1) {
        return video[1].id;
    }
    return video[0].id;
}

function toggleSound() {
    let video = videojs(getVideoId()).player();
    video.muted(!video.muted());
    mute = video.muted() ? 'muted' : null;
    let icon = document.getElementById('speaker');
    if (video.muted()) {
       icon.src = './assets/mute.svg';
    }
    else {
       icon.src = './assets/sound.svg';
    }
}

function shareLink() {
    if (navigator.share) {
        navigator.share({ title: 'Interactive Quiz Demo', url: window.location.href })
        .then(() => {
          console.log('do we need anything after sharing?');
        })
        .catch(console.error);
    }
    else {
        console.log('create share box');
    }
}

function showForm() {
    const player = videojs(getVideoId());
    player.pause();
    document.getElementById('frameDiv').style.display = 'none';
    let fieldsDiv = '';
    dataset.form.lead.forEach(element => {
        fieldsDiv += `<div class="form-group">
            <label for="${element.identifier}">${element.label}:</label>
            <input type="${element.type}" class="field" id="${element.identifier}" name="${element.identifier}">
        </div>`
    })
    document.getElementById('fieldsDiv').innerHTML = fieldsDiv;
    document.getElementById('formDiv').style.display = 'block';
}

function closeForm() {
    const player = videojs(getVideoId());
    player.play();
    document.getElementById('formDiv').style.display = 'none';
    document.getElementById('frameDiv').style.display = 'block';
}

function sendInfo() {
    let dataErr = null;
    dataset.form.lead.forEach(element => {
        if (document.getElementById(element.identifier).value.trim() !== "") {
            dataObj[element.identifier] = document.getElementById(element.identifier).value;
        }
        else {
            dataErr = true;
        }
    })
    if (dataErr === null) {
        fetch('https://k90nmo1jz3.execute-api.ap-south-1.amazonaws.com/v1/collect-lead/', {
            method: 'post',
            body: JSON.stringify(dataObj),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((response) => {
            return response.json()
        }).then((res) => {
            if (res.status === 200) {
                closeForm();
                localStorage.setItem("lead", true);
                nextVideo('1');
            }
        }).catch((error) => {
            closeInterface();
            console.log(error);
        })
    }
    else {
        closeForm();
        nextVideo('1');
        console.log("no data");
    }
}

function nextVideo(selection) {
    stopTimer()
    videojs(getVideoId()).dispose();
    document.getElementById('videosDiv').innerHTML = '';
    let text = document.getElementById('textOnVideoDiv');
    if (text !== null) {
       text.parentNode.removeChild(text);
    }
    let options = document.getElementById('currentOptionsDiv');
    if (options) {
       options.parentNode.removeChild(options);
    }
    if (selection === "won" || selection === "time" || selection === "wrong") {
        document.getElementById('videosDiv').innerHTML += `<div class="video">
            <video id="quiz-${selection}" class="video-js vjs-fill" controls="false" autoplay="true" playsinline data-setup='{"customControlsOnMobile": true}' ${mute}>
                <source src="${dataset[selection].video}" type="application/x-mpegURL">
            </video>
        </div>`;
        document.getElementById('optionsDiv').innerHTML += `<div class="currentOptions" id="currentOptionsDiv">
            <div class="question">
                <h4>${dataset[selection].message}</h4>
            </div>
            <div class="answers cta">
                <button type="button" onclick=${dataset[selection].link ? "showForm()" : "nextVideo('1')"}>${dataset[selection].option}</button>
                ${bottomText}
            </div>`;
        document.getElementById('optionsDiv').style.display = 'flex';
    }
    else if (parseInt(selection) > 0) {
        let questions = dataset[selection].questions;
        let randomQuestionNo = Math.floor(Math.random() * questions.length);
        let question = questions[randomQuestionNo].question;
        document.getElementById('videosDiv').innerHTML += `<div class="video">
            <div class="countdown"></div>
            <video id="quiz-${selection}" onended="nextQuestion(\`${question}\`, '${selection}', '${randomQuestionNo}')" class="video-js vjs-fill" controls="false" autoplay="true" playsinline data-setup='{"customControlsOnMobile": true}' ${mute}>
                <source src="${dataset[selection].questions[randomQuestionNo].video}" type="application/x-mpegURL">
            </video>
        </div>`;
    }
    videojs(`quiz-${selection}`).ready(function() { this.player_.controls(false) });
}

function nextQuestion(question, selection, randomQuestionNo) {
    let selectionOptions = '';
    let questions = dataset[selection].questions;
    let options = questions[randomQuestionNo].options;
    // options = shuffleOptions(options);
    options.forEach((o) => {
        let stage = parseInt(selection, 10);
        stage = (stage + 1).toString();
        if (dataset[stage] && o === questions[randomQuestionNo].correct){
            selectionOptions += `<button type="button" value="${o}" onclick="nextVideo('${stage}')">${o}</button>`
        }
        else if (!dataset[stage]) {
            selectionOptions += `<button type="button" value="${o}" onclick="nextVideo('won')">${o}</button>`
        }
        else {
            selectionOptions += `<button type="button" value="${o}" onclick="nextVideo('wrong')">${o}</button>`
        }
    })
    document.getElementById('optionsDiv').innerHTML += `<div class="currentOptions" id="currentOptionsDiv">
        <div class="question">
          <h4>${question}</h4>
        </div>
        <div class="answers">
          ${selectionOptions}
          ${bottomText}
        </div>`;
    document.getElementById('optionsDiv').style.display = 'flex';
    startTimer();
}

function toTitleCase(str) {
    return str.replace(/wS*/g, function (txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}

function startTimer() {
    let count = 100;
    interval = setInterval(() => {
        if (count == 0) {
            stopTimer();
            nextVideo('time');
        }
        else {
            count--;
            document.getElementsByClassName('countdown')[0].style.width = count + '%';
        }
    }, 100);
}

function shuffleOptions(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function stopTimer() {
    clearInterval(interval);
}

function openInNewTab(url) {
    window.open(url, '_blank').focus();
}